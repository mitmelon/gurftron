class CustomToast{constructor(){this.toastCounter=0,this.toasts=new Map,this.defaultOptions={duration:5e3,position:"top-right",showProgress:!0,closable:!0}}success(t,e={}){return this.show(t,"success",e)}error(t,e={}){return this.show(t,"error",e)}warning(t,e={}){return this.show(t,"warning",e)}info(t,e={}){return this.show(t,"info",e)}show(t,e="info",n={}){const r={...this.defaultOptions,...n},o=++this.toastCounter;this.ensureContainer(r.position);const i=this.createToastElement(o,t,e,r);return document.querySelector(`#toast-container-${r.position}`).appendChild(i),this.toasts.set(o,{element:i,type:e,config:r}),setTimeout(()=>{i.style.transform=this.getShowTransform(r.position),i.style.opacity="1"},10),r.duration>0&&setTimeout(()=>{this.remove(o)},r.duration),o}remove(t){const e=this.toasts.get(t);if(!e)return;const{element:n,config:r}=e;n.style.transform=this.getHideTransform(r.position),n.style.opacity="0",setTimeout(()=>{n.parentNode&&n.parentNode.removeChild(n),this.toasts.delete(t)},300)}clear(){this.toasts.forEach((t,e)=>this.remove(e))}ensureContainer(t){const e=`toast-container-${t}`;let n=document.getElementById(e);n||(n=document.createElement("div"),n.id=e,n.style.cssText=this.getContainerStyles(t),document.body.appendChild(n))}getContainerStyles(t){return"\n      position: fixed;\n      z-index: 9999;\n      max-width: 400px;\n      pointer-events: none;\n    "+{"top-right":"top: 20px; right: 20px;","top-left":"top: 20px; left: 20px;","bottom-right":"bottom: 20px; right: 20px;","bottom-left":"bottom: 20px; left: 20px;"}[t]}getShowTransform(t){return{"top-right":"translateX(0)","top-left":"translateX(0)","bottom-right":"translateX(0)","bottom-left":"translateX(0)"}[t]}getHideTransform(t){return{"top-right":"translateX(100%)","top-left":"translateX(-100%)","bottom-right":"translateX(100%)","bottom-left":"translateX(-100%)"}[t]}createToastElement(t,e,n,r){const o=document.createElement("div");o.id=`toast-${t}`;const i={success:{bg:"#10b981",border:"#059669",icon:"✓"},error:{bg:"#ef4444",border:"#dc2626",icon:"✕"},warning:{bg:"#f59e0b",border:"#d97706",icon:"⚠"},info:{bg:"#3b82f6",border:"#2563eb",icon:"ℹ"}}[n];o.style.cssText=`\n      background: ${i.bg};\n      color: white;\n      padding: 16px 20px;\n      margin-bottom: 12px;\n      border-radius: 8px;\n      border-left: 4px solid ${i.border};\n      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1), 0 4px 6px rgba(0, 0, 0, 0.05);\n      display: flex;\n      align-items: center;\n      min-width: 300px;\n      max-width: 400px;\n      opacity: 0;\n      transform: ${this.getHideTransform(r.position)};\n      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n      pointer-events: auto;\n      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;\n      font-size: 14px;\n      line-height: 1.4;\n      position: relative;\n      overflow: hidden;\n    `;const s=document.createElement("span");s.style.cssText="\n      font-size: 16px;\n      margin-right: 12px;\n      font-weight: bold;\n      flex-shrink: 0;\n    ",s.textContent=i.icon;const a=document.createElement("div");if(a.style.cssText="\n      flex: 1;\n      font-weight: 500;\n    ",a.textContent=e,o.appendChild(s),o.appendChild(a),r.closable){const e=document.createElement("button");e.style.cssText="\n        background: none;\n        border: none;\n        color: white;\n        font-size: 16px;\n        cursor: pointer;\n        padding: 4px;\n        margin-left: 12px;\n        opacity: 0.8;\n        transition: opacity 0.2s;\n        flex-shrink: 0;\n      ",e.innerHTML="×",e.onmouseover=()=>e.style.opacity="1",e.onmouseout=()=>e.style.opacity="0.8",e.onclick=()=>this.remove(t),o.appendChild(e)}if(r.showProgress&&r.duration>0){const t=document.createElement("div");t.style.cssText=`\n        position: absolute;\n        bottom: 0;\n        left: 0;\n        height: 3px;\n        background: rgba(255, 255, 255, 0.3);\n        width: 100%;\n        animation: toast-progress ${r.duration}ms linear;\n      `,this.addProgressAnimation(),o.appendChild(t)}return o}addProgressAnimation(){if(document.getElementById("toast-progress-style"))return;const t=document.createElement("style");t.id="toast-progress-style",t.textContent="\n      @keyframes toast-progress {\n        from { width: 100%; }\n        to { width: 0%; }\n      }\n    ",document.head.appendChild(t)}}class AjaxHandler{constructor(){this.signal=null,this.controller=new AbortController,this.toast=new CustomToast,this.loaders={default:'<div style="display: inline-flex; align-items: center;">\n                  <div style="width: 16px; height: 16px; border: 2px solid #ffffff; border-top: 2px solid transparent; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 8px;"></div>\n                  Loading...\n                </div>',centerLoader:'<div style="display: flex; justify-content: center; align-items: center; padding: 20px;">\n                      <div style="width: 24px; height: 24px; border: 3px solid #e5e7eb; border-top: 3px solid #3b82f6; border-radius: 50%; animation: spin 1s linear infinite;"></div>\n                    </div>',themeLoader:'<div style="display: inline-flex; align-items: center;">\n                      <div style="width: 14px; height: 14px; border: 2px solid currentColor; border-top: 2px solid transparent; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 6px;"></div>\n                      Please wait...\n                    </div>',pageLoader:'<div style="display: flex; align-items: center; justify-content: center; width: 100%;">\n                     <div style="width: 20px; height: 20px; border: 2px solid #f3f4f6; border-top: 2px solid #6366f1; border-radius: 50%; animation: spin 1s linear infinite;"></div>\n                   </div>'},this.addSpinAnimation()}addSpinAnimation(){if(document.getElementById("ajax-spin-style"))return;const t=document.createElement("style");t.id="ajax-spin-style",t.textContent="\n      @keyframes spin {\n        0% { transform: rotate(0deg); }\n        100% { transform: rotate(360deg); }\n      }\n    ",document.head.appendChild(t)}storage={get:t=>localStorage.getItem(t)||"",set:(t,e)=>localStorage.setItem(t,e)};NProgress={start:()=>console.log("Progress started"),done:()=>console.log("Progress done")};animateCSS=(t,e)=>{const n="string"==typeof t?document.querySelector(t):t;n&&(n.style.animation=`${e} 0.5s`,setTimeout(()=>{n.style.animation=""},500))};async ajaxFormData(t,e,n,r,o=null,i=null,s=null,a="default",l="top-right"){try{if(r.append("latitude",this.storage.get("latitude")),r.append("longitude",this.storage.get("longitude")),null!==o&&null!==i&&this.NProgress.start(),null!==o&&""!==o&&void 0!==o){const t=document.querySelector(o);t&&(t.classList.remove("btn-dim"),t.disabled=!0,t.style.opacity="0.5",t.style.pointerEvents="none",this.loaders[a]?t.innerHTML=this.loaders[a]:t.innerHTML=a)}this.controller=new AbortController,this.signal=this.controller.signal;const c=await fetch(n,{method:e,body:r,signal:this.signal}),d=await c.json();c.ok&&200===d.status?(this.resetButton(o,i),"function"==typeof s&&s(d,i),null!==t&&null!==i&&null!==o&&this.NProgress.done()):(this.resetButton(o,i),this.toast.error(d.error||"An error occurred",{position:l}),null!==t&&this.animateCSS(t,"shake"),null!==t&&null!==i&&null!==o&&this.NProgress.done())}catch(e){if(this.resetButton(o,i),null!==t&&this.animateCSS(t,"shake"),null!==t&&null!==i&&null!==o&&this.NProgress.done(),"AbortError"===e.name)return;"TimeoutError"===e.name?this.toast.error("Timeout reached. Please try again",{position:l}):this.toast.error(e.message||"System error occurred",{position:l})}}resetButton(t,e){if(null!==t&&""!==t&&void 0!==t){const n=document.querySelector(t);n&&(n.disabled=!1,n.style.opacity="1",n.style.pointerEvents="",null!==e&&""!==e&&void 0!==e&&(n.innerHTML=e))}document.querySelectorAll("#maloaders").forEach(t=>t.remove())}cancelRequest(){this.controller&&this.controller.abort()}}class PageLoader{constructor(t={}){this.options={timeout:1e4,executeScripts:!0,loadStyles:!0,sanitize:!1,baseUrl:chrome?.runtime?.getURL("")||"",...t},this.loadedScripts=new Set,this.loadedStyles=new Set,this.pageCache=new Map}async loadPage(t,e=null,n={}){try{const r={...this.options,...n};if(null===e)return await this.loadFullPage(t,r);const o="string"==typeof e?document.querySelector(e):e;if(!o)throw new Error(`Target container not found: ${e}`);const i=`${t}-${JSON.stringify(r)}`;if(this.pageCache.has(i)&&!r.bypassCache)return console.log(`Loading page from cache: ${t}`),this.injectCachedContent(o,this.pageCache.get(i));console.log(`Loading page: ${t}`);const s=await this.fetchPageContent(t,r.timeout),a=await this.processContent(s,t,r);return r.bypassCache||this.pageCache.set(i,a),await this.injectContent(o,a)}catch(e){return console.error(`Failed to load page ${t}:`,e),window.core?.storage&&await window.core.storage.logError("PAGE_LOAD",`Failed to load ${t}: ${e.message}`),{success:!1,error:e.message,path:t}}}async fetchPageContent(t,e){const n=t.startsWith("http")?t:this.options.baseUrl+t.replace(/^\//,""),r=new AbortController,o=setTimeout(()=>r.abort(),e);try{const t=await fetch(n,{signal:r.signal,method:"GET",headers:{"Content-Type":"text/html"}});if(clearTimeout(o),!t.ok)throw new Error(`HTTP ${t.status}: ${t.statusText}`);return await t.text()}catch(t){if(clearTimeout(o),"AbortError"===t.name)throw new Error("Request timeout");throw t}}async processContent(t,e,n){const r=(new DOMParser).parseFromString(t,"text/html"),o=e.substring(0,e.lastIndexOf("/")+1),i={html:"",inlineScripts:[],externalScripts:[],inlineStyles:[],externalStyles:[],meta:{},title:r.title||""};r.querySelectorAll("meta").forEach(t=>{t.name&&(i.meta[t.name]=t.content),t.property&&(i.meta[t.property]=t.content)}),n.loadStyles&&await this.extractStyles(r,i,o),n.executeScripts&&await this.extractScripts(r,i,o);const s=r.body?r.body.innerHTML:r.documentElement.innerHTML;return i.html=n.sanitize?this.sanitizeHTML(s):s,i}async extractStyles(t,e,n){t.querySelectorAll("style").forEach(t=>{e.inlineStyles.push(t.textContent),t.remove()});const r=t.querySelectorAll('link[rel="stylesheet"]');for(const t of r){const r=this.resolveURL(t.getAttribute("href"),n);e.externalStyles.push({url:r,media:t.getAttribute("media")||"all",integrity:t.getAttribute("integrity"),crossorigin:t.getAttribute("crossorigin")}),t.remove()}}async extractScripts(t,e,n){t.querySelectorAll("script:not([src])").forEach(t=>{t.textContent.trim()&&e.inlineScripts.push({content:t.textContent,type:t.getAttribute("type")||"text/javascript",async:t.hasAttribute("async"),defer:t.hasAttribute("defer")}),t.remove()}),t.querySelectorAll("script[src]").forEach(t=>{const r=this.resolveURL(t.getAttribute("src"),n);e.externalScripts.push({url:r,type:t.getAttribute("type")||"text/javascript",async:t.hasAttribute("async"),defer:t.hasAttribute("defer"),integrity:t.getAttribute("integrity"),crossorigin:t.getAttribute("crossorigin")}),t.remove()})}async injectContent(t,e){try{return await this.loadExternalStyles(e.externalStyles),this.injectInlineStyles(e.inlineStyles),e.title&&e.title!==document.title&&(document.title=e.title),t.innerHTML=e.html,await this.loadExternalScripts(e.externalScripts),await this.executeInlineScripts(e.inlineScripts),{success:!0,content:e,container:t,scriptsLoaded:e.externalScripts.length+e.inlineScripts.length,stylesLoaded:e.externalStyles.length+e.inlineStyles.length}}catch(t){throw new Error(`Content injection failed: ${t.message}`)}}async loadFullPage(t,e){try{console.log(`Loading full page: ${t}`);const n=await this.fetchPageContent(t,e.timeout),r=(new DOMParser).parseFromString(n,"text/html"),o=await this.processFullDocument(r,t,e);return await this.replaceDocument(o)}catch(t){throw new Error(`Full page load failed: ${t.message}`)}}async processFullDocument(t,e,n){const r=e.substring(0,e.lastIndexOf("/")+1),o={html:t.documentElement.outerHTML,head:t.head.innerHTML,body:t.body.innerHTML,title:t.title||"",inlineScripts:[],externalScripts:[],inlineStyles:[],externalStyles:[],meta:{}};return t.querySelectorAll("meta").forEach(t=>{t.name&&(o.meta[t.name]=t.content),t.property&&(o.meta[t.property]=t.content)}),n.loadStyles&&await this.extractStyles(t,o,r),n.executeScripts&&await this.extractScripts(t,o,r),o}async replaceDocument(t){try{document.documentElement.innerHTML="";const e=(new DOMParser).parseFromString(t.html,"text/html");Array.from(e.documentElement.attributes).forEach(t=>{document.documentElement.setAttribute(t.name,t.value)}),document.head.innerHTML=e.head.innerHTML,document.body.innerHTML=e.body.innerHTML,Array.from(e.body.attributes).forEach(t=>{document.body.setAttribute(t.name,t.value)}),t.title&&(document.title=t.title),await this.loadExternalStyles(t.externalStyles),this.injectInlineStyles(t.inlineStyles),await this.loadExternalScripts(t.externalScripts),await this.executeInlineScripts(t.inlineScripts);const n=new Event("DOMContentLoaded",{bubbles:!0,cancelable:!0});return document.dispatchEvent(n),{success:!0,fullPageReplacement:!0,title:t.title,scriptsLoaded:t.externalScripts.length+t.inlineScripts.length,stylesLoaded:t.externalStyles.length+t.inlineStyles.length}}catch(t){throw new Error(`Document replacement failed: ${t.message}`)}}async injectCachedContent(t,e){return t.innerHTML=e.html,this.injectInlineStyles(e.inlineStyles),{success:!0,cached:!0,content:e,container:t}}async loadExternalStyles(t){const e=t.map(async t=>{if(!this.loadedStyles.has(t.url))return new Promise((e,n)=>{const r=document.createElement("link");r.rel="stylesheet",r.href=t.url,r.media=t.media||"all",t.integrity&&(r.integrity=t.integrity),t.crossorigin&&(r.crossOrigin=t.crossorigin),r.onload=()=>{this.loadedStyles.add(t.url),e()},r.onerror=()=>{console.warn(`Failed to load stylesheet: ${t.url}`),e()},document.head.appendChild(r)});console.log(`Style already loaded: ${t.url}`)});await Promise.allSettled(e)}injectInlineStyles(t){t.forEach((t,e)=>{const n=`injected-style-${Date.now()}-${e}`;if(!document.getElementById(n)){const e=document.createElement("style");e.id=n,e.textContent=t,document.head.appendChild(e)}})}async loadExternalScripts(t){const e=t.filter(t=>!t.defer),n=t.filter(t=>t.defer);for(const t of e)this.loadedScripts.has(t.url)||await this.loadSingleScript(t);for(const t of n)this.loadedScripts.has(t.url)||await this.loadSingleScript(t)}loadSingleScript(t){return new Promise((e,n)=>{const r=document.createElement("script");r.src=t.url,r.type=t.type,t.async&&(r.async=!0),t.defer&&(r.defer=!0),t.integrity&&(r.integrity=t.integrity),t.crossorigin&&(r.crossOrigin=t.crossorigin),r.onload=()=>{this.loadedScripts.add(t.url),console.log(`Script loaded: ${t.url}`),e()},r.onerror=n=>{console.error(`Failed to load script: ${t.url}`,n),e()},document.head.appendChild(r)})}async executeInlineScripts(t){for(const e of t)try{"text/javascript"!==e.type&&e.type||((0,eval)(e.content),console.log("Executed inline script"))}catch(t){console.error("Inline script execution failed:",t)}}resolveURL(t,e){return t?t.startsWith("http://")||t.startsWith("https://")||t.startsWith("//")?t:t.startsWith("/")?this.options.baseUrl+t.substring(1):this.options.baseUrl+e+t:""}sanitizeHTML(t){const e=document.createElement("div");e.innerHTML=t;const n=["onclick","onload","onerror","onmouseover"];return e.querySelectorAll("*").forEach(t=>{n.forEach(e=>{t.hasAttribute(e)&&t.removeAttribute(e)})}),e.innerHTML}clearCache(){this.pageCache.clear(),console.log("Page loader cache cleared")}async preloadPage(t,e={}){const n={...this.options,...e},r=await this.fetchPageContent(t,n.timeout),o=await this.processContent(r,t,n),i=`${t}-${JSON.stringify(n)}`;return this.pageCache.set(i,o),o}}class SimpleRoute{constructor(){this.routes=new Map,this.registeredRoute=[]}route(t,e){if("string"!=typeof t||"function"!=typeof e)throw new TypeError("Action must be a string and callback must be a function");const n=t.trim().replace(/^\/+|\/+$/g,"");this.registeredRoute.push(n),this.routes.set(n,e)}dispatch(t){if("string"!=typeof t)throw new TypeError("Action must be a string");const e=t.trim().replace(/^\/+|\/+$/g,"");if(this.validateRoute(e)){const t=this.routes.get(e);return t?t():null}return null}validateRoute(t){const e=t.trim().replace(/^\/+|\/+$/g,"");return this.registeredRoute.includes(e)}}